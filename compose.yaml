# This docker compose is for testing a real production env locally..
# Simulates a network etc.
version: '3.7'

services:
  # ----- GENERAL SERVICES -------
  service_webserver:
    image: ahmad45123/workup:webserver
    depends_on:
      - service_mq
      - service_mediaserver
    ports:
      - "80:8080"
    networks:
      - frontend
    env_file:
      - ./webserver/.env
    deploy:
      labels:
        swarm.autoscaler: 'true'
        swarm.autoscaler.minimum: '1'
        swarm.autoscaler.maximum: '4'

  service_mediaserver:
    image: ahmad45123/workup:mediaserver
    ports:
      - "8080:8080"
    env_file:
      - ./mediaserver/.env
  
  service_mq:
    image: rabbitmq:3.13-management
    ports:
      - "5672:5672" # hacky method.. dont ever do this :(
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
    networks:
      - default
      - frontend

  service_redis:
    image: redis:7.2.4
    healthcheck:
      test: redis-cli ping
      interval: 30s
      timeout: 30s
      retries: 3
    networks:
      - default

  # ----- JOBS MICROSERVICE -------
  service_jobs:
    image: ahmad45123/workup:service_jobs
    depends_on:
      - jobs_db
      - service_mq
    networks:
      - default
      - jobs
    env_file:
      - ./services/jobs/.env
    volumes:
      - /logs/jobs:/app/logs
    deploy:
      labels:
        swarm.autoscaler: 'true'
        swarm.autoscaler.minimum: '1'
        swarm.autoscaler.maximum: '3'

  jobs_db:
    image: ahmad45123/workup:sasicassandra
    healthcheck:
      test: [ "CMD", "cqlsh", "-e", "describe keyspaces" ]
      interval: 20s
      timeout: 10s
      retries: 60
    networks:
      - jobs

  # ----- PAYMENTS MICROSERVICE -------
  service_payments:
    image: ahmad45123/workup:service_payments
    depends_on:
      - payments_db
      - service_mq
      - service_redis
    networks:
      - default
      - payments
    env_file:
      - ./services/payments/.env
    deploy:
      labels:
        swarm.autoscaler: 'true'
        swarm.autoscaler.minimum: '1'
        swarm.autoscaler.maximum: '3'

  payments_db:
    image: postgres:12.18
    environment:
      POSTGRES_PASSWORD: payments_password
      POSTGRES_USER: payments_user
      POSTGRES_DB: payments_database
    healthcheck:
      test: [ "CMD", "pg_isready" ]
      interval: 20s
      timeout: 10s
      retries: 10
    networks:
      - payments

  # ----- CONTRACTS MICROSERVICE -------
  service_contracts:
    image: ahmad45123/workup:service_contracts
    depends_on:
      - contracts_db
      - service_mq
    networks:
      - default
      - contracts
    env_file:
      - ./services/contracts/.env
    deploy:
      labels:
        swarm.autoscaler: 'true'
        swarm.autoscaler.minimum: '1'
        swarm.autoscaler.maximum: '3'

  contracts_db:
    image: cassandra:4.0.7
    healthcheck:
      test: [ "CMD", "cqlsh", "-e", "describe keyspaces" ]
      interval: 20s
      timeout: 10s
      retries: 60
    networks:
      - contracts

  # ----- USERS MICROSERVICE -------
  service_users:
    image: ahmad45123/workup:service_users
    depends_on:
      - users_db
      - service_mq
    networks:
      - default
      - users
    env_file:
      - ./services/users/.env
    deploy:
      labels:
        swarm.autoscaler: 'true'
        swarm.autoscaler.minimum: '1'
        swarm.autoscaler.maximum: '3'
  
  users_db:
    image: mongo:7.0
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: user
      MONGO_INITDB_ROOT_PASSWORD: password
    networks:
      - users


networks:
  default:
  jobs:
  payments:
  contracts:
  users:
  frontend:
